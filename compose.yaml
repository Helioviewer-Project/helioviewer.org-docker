name: helioviewer
x-volumes:
  # Source code for Helioviewer API back end
  api-mount: &api-mount
    type: bind
    source: ${PWD}/api
    target: /var/www/api.helioviewer.org
  # Source code for helioviewer.org front-end web client
  client-mount: &client-mount
    type: bind
    source: ${PWD}/helioviewer.org
    target: /var/www/html
  # Scripts for loading in images
  install-mount: &install-mount
    type: bind
    source: ${PWD}/api/install
    target: /scripts
  # Setup scripts for headless database initialization
  setup-scripts-mount: &setup-scripts-mount
    type: bind
    source: ${PWD}/scripts/database
    target: /setup_scripts
  # Volume for JPEG2000 images
  jp2-mount: &jp2-mount
    type: bind
    source: ${HOST_JPEG2000_PATH}
    target: /tmp/jp2
  # Cache stores various data cached by helioviewer. Tiles, screenshots, movies, etc
  cache-mount: &cache-mount
    type: bind
    source: ${HOST_CACHE_PATH}
  # Logs generated by the Helioviewer API
  log-mount: &log-mount
    type: bind
    source: ${HOST_LOG_PATH}
    target: /var/www/api.helioviewer.org/log
  db-data: &db-data
    type: volume
    source: db_volume
    target: /var/lib/mysql

volumes:
  # To persist database data
  db_volume:

services:
  database:
    image: mariadb
    environment:
      MARIADB_ROOT_PASSWORD: ${DATABASE_ROOT_PASSWORD}
    restart: always
    healthcheck:
      test: ["CMD", "bash", "/usr/local/bin/healthcheck.sh", "--connect"]
      interval: 5s
      timeout: 5s
      retries: 3
    volumes:
      - *jp2-mount
      - *install-mount
      - *db-data
  # Initialize database service with application data and credentials
  # TODO: move this to manage.sh
  database-init:
    image: ghcr.io/helioviewer-project/python
    build:
      dockerfile: docker/python.Dockerfile
    platform: linux/x86_64
    environment:
      MARIADB_ROOT_PASSWORD: ${DATABASE_ROOT_PASSWORD}
      HV_DB_NAME: ${HV_DB_NAME}
      HV_DB_USER: ${HV_DB_USER}
      HV_DB_PASS: ${HV_DB_PASS}
    volumes:
      - *jp2-mount
      - *install-mount
      - *setup-scripts-mount
    entrypoint: /bin/bash
    command:
      - /setup_scripts/initialize_database.sh
    depends_on:
      database:
        condition: service_healthy
  redis:
    image: redis
    restart: always
  # Supporting python api for the helioviewer api
  coordinator:
    restart: always
    image: dgarciabriseno/hv-coordinator:0.3.3
    ports:
      - 127.0.0.1:${COORDINATOR_PORT}:80
  api:
    env_file:
      - .env
    image: ghcr.io/helioviewer-project/php
    build:
      dockerfile: docker/php.Dockerfile
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - 127.0.0.1:${API_PORT}:80
    depends_on:
      database-init:
        condition: service_completed_successfully
      database:
        condition: service_started
      redis:
        condition: service_started
      coordinator:
        condition: service_started
    restart: always
    platform: linux/amd64
    healthcheck:
      # Check if Apache is responding on port 80
      test: ["CMD", "curl", "-f", "http://localhost/?action=getStatus"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 5s
    volumes:
      - *jp2-mount
      - *api-mount
      - <<: *cache-mount
        target: /var/www/helioviewer.org/cache
      - <<: *cache-mount
        target: /var/www/api.helioviewer.org/docroot/cache
      - *log-mount
  web:
    env_file:
      - .env
    environment:
      APACHE_DOCUMENT_ROOT: /var/www/html
    image: ghcr.io/helioviewer-project/php
    ports:
      - 127.0.0.1:${CLIENT_PORT}:80
    depends_on:
      database-init:
        condition: service_completed_successfully
      api:
        condition: service_started
    restart: always
    healthcheck:
      # Check every 10 seconds, wait up to 2 minutes
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 10s
      timeout: 1s
      retries: 12
    volumes:
      - *client-mount
      - *api-mount
      - <<: *cache-mount
        target: /var/www/html/cache
  movies:
    env_file:
      - .env
    restart: always
    image: ghcr.io/helioviewer-project/movie-worker
    depends_on:
      database-init:
        condition: service_completed_successfully
      redis:
        condition: service_started
    build:
      dockerfile: docker/movies.Dockerfile
    platform: linux/amd64
    volumes_from:
      - api

